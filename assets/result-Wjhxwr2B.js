import"./main-3C7Y8jW-.js";function b(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function E(e){return Array.isArray(e)?e:e==null?[]:[e]}function i(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function D(e){return{status:"extensions",div:`<div xmlns="http://www.w3.org/1999/xhtml">${e}</div>`}}function R(e){if(!e)return"";const t=Array.isArray(e)?e[0]:e;return t?.display||t?.code||""}function N(e){return(Array.isArray(e?.name)?e.name:[])[0]?.family||""}function Q(e){const t=Array.isArray(e?.identifier)?e.identifier:[];for(const n of t)if((n?.type?.coding||[]).some(u=>(u.code||"").toLowerCase()==="pid"))return n.value||"";for(const n of t)if((n.system||"").toLowerCase().includes("pid"))return n.value||"";return t.length&&t[0].value||""}function L(e,t){const n=t?.patient||null,a=t?.subjectRefStr||"",u=t?.authorDisplay||"",c=n?N(n):"",r=n?.birthDate||"";let o=n?Q(n):"";if(!o&&a){const y=a.match(/(^|\/)Patient\/([^\/?#]+)/i);o=y&&y[2]||""}const d=`
    <h2>Dokumenten-Header</h2>
    <table class="grid">${[`<tr><th>Patient (Familienname)</th><td>${i(c)}</td></tr>`,`<tr><th>Geburtsdatum</th><td>${i(r)}</td></tr>`,`<tr><th>Patienten-ID (pid)</th><td>${i(o)}</td></tr>`,`<tr><th>Status</th><td>${i(e.status||"")}</td></tr>`,`<tr><th>Dokumenttyp</th><td>${i(e.type?.text||"")}</td></tr>`,`<tr><th>Datum</th><td>${i(e.date||"")}</td></tr>`,`<tr><th>Titel</th><td>${i(e.title||"")}</td></tr>`,`<tr><th>Autor</th><td>${i(u)}</td></tr>`].join("")}</table>
  `;return D(d)}function O(e){return typeof e=="string"&&/^-?\d+(?:[\.,]\d+)?(?:[eE][+-]?\d+)?$/.test(e.trim())}function $(e){if(e&&O(e.value)){const t=e.value.replace(",","."),n=Number(t);Number.isNaN(n)||(e.value=n)}}function P(e){if(!e||e.resourceType!=="Observation")return e;if(Object.prototype.hasOwnProperty.call(e,"derivedFrom"))try{delete e.derivedFrom}catch{}return e.valueQuantity&&$(e.valueQuantity),Array.isArray(e.component)&&e.component.forEach(t=>{t.valueQuantity&&$(t.valueQuantity)}),e}function F(e,t){if(!e||!t)return;const n={url:"http://hl7.org/fhir/StructureDefinition/display",valueString:String(t)};e._questionnaire=e._questionnaire||{};const a=Array.isArray(e._questionnaire.extension)?e._questionnaire.extension:[],u=a.findIndex(c=>c&&c.url===n.url);u>=0?a[u]={...a[u],valueString:n.valueString}:a.push(n),e._questionnaire.extension=a}function K(e){return e?e.valueString!=null||e.valueBoolean!=null||e.valueInteger!=null||e.valueDecimal!=null||e.valueCodeableConcept!=null||e.valueQuantity!=null||e.valueDateTime!=null||e.valueDate!=null||e.valueTime!=null:!1}function T(e){return e?.code?.text||R(e?.code?.coding)||`Observation ${e?.id||""}`.trim()}function j(e){if(!e)return"";const t=e.value!=null?e.value:"",n=e.unit||e.code||e.system||"";return`${t} ${n}`.trim()}function U(e){return e?e.valueString!=null?i(e.valueString):e.valueBoolean!=null?e.valueBoolean?"ja":"nein":e.valueInteger!=null?String(e.valueInteger):e.valueDecimal!=null?String(e.valueDecimal):e.valueCodeableConcept?i(e.valueCodeableConcept.text||R(e.valueCodeableConcept.coding)):e.valueQuantity?i(j(e.valueQuantity)):e.valueDateTime?i(e.valueDateTime):e.valueDate?i(e.valueDate):e.valueTime?i(e.valueTime):"":""}function k(e){const t=i(T(e)),n=e.effectiveDateTime||e.effectivePeriod?.start||"",a=e.performer&&e.performer[0]?.display||"",u=U(e),c=[u?`<tr><th>Wert</th><td>${i(u)}</td></tr>`:"",n?`<tr><th>Erhoben am</th><td>${i(n)}</td></tr>`:"",a?`<tr><th>Erhoben von</th><td>${i(a)}</td></tr>`:""].filter(Boolean).join(""),r=`
    <h2>${t}</h2>
    <table class="grid">
      ${c||'<tr><td colspan="2">(keine Details)</td></tr>'}
    </table>
  `;return D(r)}function z(e){return e?e.valueString!=null?i(e.valueString):e.valueBoolean!=null?e.valueBoolean?"ja":"nein":e.valueInteger!=null?String(e.valueInteger):e.valueDecimal!=null?String(e.valueDecimal):e.valueDate?i(e.valueDate):e.valueDateTime?i(e.valueDateTime):e.valueTime?i(e.valueTime):e.valueCoding?i(e.valueCoding.display||e.valueCoding.code||""):e.valueQuantity?i(j(e.valueQuantity)):e.valueReference?i(e.valueReference.display||e.valueReference.reference||""):"":""}function B(e,t){Array.isArray(e)&&e.forEach(n=>{const a=i(n.text||n.linkId||""),u=(n.answer||[]).map(c=>z(c)).filter(Boolean).join(", ");(a||u)&&t.push(`<li><strong>${a}:</strong> ${u||"—"}</li>`),n.item&&B(n.item,t)})}function I(e){const t=[e.status?`<tr><th>Status</th><td>${i(e.status)}</td></tr>`:"",e.authored?`<tr><th>Erstellt</th><td>${i(e.authored)}</td></tr>`:"",e.subject?.display||e.subject?.reference?`<tr><th>Patient</th><td>${i(e.subject.display||e.subject.reference)}</td></tr>`:""].filter(Boolean).join(""),n=[];B(e.item,n);const a=`
    <h2>Fragebogen</h2>
    <table class="grid">${t}</table>
    ${n.length?`<ul>${n.join("")}</ul>`:"<div>(keine Antworten)</div>"}
  `;return D(a)}function M(e){if(e&&e.subject&&typeof e.subject=="object")return{reference:e.subject.reference,display:e.subject.display};if(e&&typeof e.subject=="string")return{reference:e.subject}}function H(e){if(e&&e.encounter&&typeof e.encounter=="object")return{reference:e.encounter.reference,display:e.encounter.display};if(e&&typeof e.encounter=="string")return{reference:e.encounter}}function J(e){const t=e?.questionnaireResponse,n=E(e?.observations).filter(Boolean).map(P).filter(K);if(!t||t.resourceType!=="QuestionnaireResponse")return null;const a=e?.meta?.generatedAt||new Date().toISOString(),u=b(),c=b(),r=t.id||c;t.id||(t.id=r);const o=n.map(l=>l?.id||b());let f="LHC-Forms Demo App";t&&t.author&&(typeof t.author=="object"?f=t.author.display||t.author.reference||f:typeof t.author=="string"&&(f=t.author||f));const d=M(t),y=H(t);let m=null,h=null;const x=d?.reference||(typeof d=="string"?d:null);if(x){const l=x.match(/(^|\/)Patient\/([^\/?#]+)/i),s=l&&l[2];if(s){const A=`Patient/${s}`;m={fullUrl:A,resource:{resourceType:"Patient",id:s,identifier:[{system:"urn:source-id",value:s}]}},h={reference:A}}}const p=`Composition/${u}`,S=`QuestionnaireResponse/${r}`,v={resourceType:"Composition",id:u,status:"final",identifier:{system:"urn:ietf:rfc:3986",value:`urn:uuid:${u}`},meta:{profile:["https://gematik.de/fhir/isik/StructureDefinition/ISiKBerichtSubSysteme"]},type:{coding:[{system:"http://dvmd.de/fhir/CodeSystem/kdl",code:"AM170103",display:"Patientenfragebogen"}],text:"AM170103 - Patientenfragebogen"},date:a,title:"ISiK Bericht",...h||d?{subject:h||d}:{},...y?{encounter:y}:{},author:[{display:f}],section:[{title:"QuestionnaireResponse",text:I(t),entry:[{reference:S}]},...n.map((l,s)=>({title:T(l),text:k(l),entry:[{reference:`Observation/${o[s]}`}]}))]};try{const l=h?.reference||d?.reference||(typeof d=="string"?d:"")||"";v.text=L(v,{patient:m?.resource||null,subjectRefStr:l,authorDisplay:f})}catch{}const g={resourceType:"Bundle",type:"document",timestamp:a,identifier:{system:"urn:ietf:rfc:3986",value:`urn:uuid:${b()}`},meta:{profile:["https://gematik.de/fhir/isik/StructureDefinition/ISiKBerichtBundle"]},entry:[{fullUrl:p,resource:v},...m?[m]:[],{fullUrl:S,resource:t},...n.map((l,s)=>({fullUrl:`Observation/${o[s]}`,resource:{...l||{},id:o[s]}}))]};try{t.text=I(t);const l=e?.meta?.questionnaireTitle;l&&F(t,l),t.meta=t.meta||{};const s=Array.isArray(t.meta.profile)?t.meta.profile.slice():[];s.includes("https://gematik.de/fhir/isik/StructureDefinition/ISiKFormularDaten")||s.push("https://gematik.de/fhir/isik/StructureDefinition/ISiKFormularDaten"),t.meta.profile=s}catch{}return n.forEach((l,s)=>{try{l.text=k(l)}catch{}}),g}const C=e=>document.getElementById(e);function _(e){return new URLSearchParams(window.location.search).get(e)}function G(){const e=_("k");if(!e)return{error:"Kein Schlüssel (k) in URL gefunden."};try{const t=localStorage.getItem(e);if(!t)return{error:"Keine Exportdaten im localStorage gefunden."};const n=JSON.parse(t);try{localStorage.removeItem(e)}catch{}return{data:n}}catch(t){return{error:"Fehler beim Laden/Parsen der Exportdaten: "+t.message}}}function w(e){try{return JSON.stringify(e,null,2)}catch{return String(e)}}function V(e){const t=C("tabs");if(!t)return;t.replaceChildren();const n=document.createElement("div");n.className="tab-list";const a=document.createElement("div");a.className="tab-panels";const u=r=>"tab-"+r;e.forEach((r,o)=>{const f=document.createElement("button");f.className="tab-btn";const d=(()=>{try{return r?.resourceType!=="Bundle"?!1:Array.isArray(r?.meta?.profile)&&r.meta.profile.includes("https://gematik.de/fhir/isik/StructureDefinition/ISiKBerichtBundle")?!0:(r?.meta?.tag||[]).some(l=>l?.code==="isik-bundle")}catch{return!1}})(),y=d?"ISiKBerichtBundle":r&&r.resourceType?`${r.resourceType}${r.id?" #"+r.id:""}`:`Resource ${o+1}`;f.textContent=y,f.setAttribute("data-for",u(o)),n.appendChild(f);const m=document.createElement("div");m.className="tab-panel",m.id=u(o);const h=document.createElement("div");h.className="panel-actions";const x=document.createElement("div");x.className="hint",x.textContent=y;const p=document.createElement("button");p.className="btn small secondary",p.textContent="JSON kopieren",p.onclick=async()=>{try{await navigator.clipboard.writeText(w(r)),p.textContent="Kopiert!",setTimeout(()=>p.textContent="JSON kopieren",1200)}catch{p.textContent="Fehler",setTimeout(()=>p.textContent="JSON kopieren",1200)}},h.appendChild(x),h.appendChild(p);const S=(()=>{try{if(r?.resourceType==="Bundle"&&r?.type==="document"&&(r?.meta?.tag||[]).some(s=>s?.code==="isik-bundle")){const s=document.createElement("div");return s.className="hint",s.textContent="Aus Demogründen wurde der KDL Typ 'AM170103 - Patientenfragebogen' für die Composition gewählt. Hier muss natürlich ein passender Code gesetzt werden",s}}catch{}return null})(),v=document.createElement("pre");if(v.className="json-box",v.textContent=w(r),m.appendChild(h),S&&m.appendChild(S),!S&&d){const g=document.createElement("div");g.className="hint",g.textContent="Aus Demogründen wurde der KDL Typ 'AM170103 - Patientenfragebogen' für die Composition gewählt. Hier muss natürlich ein passender Code gesetzt werden",m.appendChild(g)}m.appendChild(v),a.appendChild(m)}),t.appendChild(n),t.appendChild(a);const c=r=>{Array.from(t.querySelectorAll(".tab-btn")).forEach(o=>o.classList.toggle("active",o.getAttribute("data-for")===r)),Array.from(t.querySelectorAll(".tab-panel")).forEach(o=>o.classList.toggle("active",o.id===r))};n.addEventListener("click",r=>{const o=r.target.closest(".tab-btn");o&&c(o.getAttribute("data-for"))}),e.length>0&&c("tab-0"),t.classList.remove("hidden")}(function(){const{data:t,error:n}=G(),a=C("metaLine");if(n){a.textContent=n,a.classList.add("err"),C("emptyMsg").textContent="Keine Daten zum Anzeigen.";return}const u=[];t?.meta?.generatedAt&&u.push("Erzeugt: "+new Date(t.meta.generatedAt).toLocaleString()),t?.meta?.includeObservations?u.push("Inklusive Observations"):u.push("Nur QuestionnaireResponse"),a.textContent=u.join(" | ");const c=[];t?.questionnaireResponse&&c.push(t.questionnaireResponse),Array.isArray(t?.observations)&&c.push(...t.observations);try{const r=J({questionnaireResponse:t?.questionnaireResponse,observations:t?.observations,meta:t?.meta});r&&c.push(r)}catch(r){console.warn("ISiK BerichtsBundle konnte nicht erzeugt werden:",r?.message||r)}if(c.length===0){C("emptyMsg").textContent="Keine Ressourcen vorhanden.";return}V(c)})();
