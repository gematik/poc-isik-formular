import"./footer-Dfnvxtua.js";/* empty css                */const g=e=>document.getElementById(e),U=()=>g("status"),l=(e,n)=>{const t=U();t&&(t.className=n||"",t.textContent=e||"")};let I,k;function h(...e){const n=new URLSearchParams(window.location.search);for(const t of e){const i=n.get(t);if(i!==null&&i!=="")return i}return null}function L(){const e=["base","prepopBase","pid","fid","qCanonical","patient","encounter","user","id","q","minimal"],n={};for(const t of e){const i=g(t);i&&i.value.trim()!==""&&(n[t]=i.value.trim())}return n}function _(e){const n=["base","prepopBase","pid","fid","qCanonical","patient","encounter","user","id","q"];for(const t of n)g(t)&&e[t]!==void 0&&e[t]!==null&&(g(t).value=String(e[t]))}function x(){const e={base:h("base"),prepopBase:h("prepopBase"),pid:h("pid"),fid:h("fid"),qCanonical:h("qCanonical","canonical"),patient:h("patient"),encounter:h("encounter"),user:h("user"),id:h("id"),q:h("q","questionnaire"),minimal:(h("minimal")||"").toLowerCase()==="true"?"true":void 0};return I=e.minimal,k=h("browse"),_(e),e}function $(e,n){if(!n)return e;if(/^https?:/i.test(n))return n;const t=(e||"").replace(/\/?$/,""),i=String(n).replace(/^\//,"");return`${t}/${i}`}function D(){const e=L();return I==="true"&&(e.minimal="true"),k&&(e.browse=k),e}function j(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%2F/gi,"/").replace(/%7C/gi,"|")}function B(){const e=window.location.origin+window.location.pathname,n=D(),t=[];for(const[m,b]of Object.entries(n))b!=null&&String(b)!==""&&t.push(`${m}=${j(String(b))}`);const i=t.join("&"),s=i?`${e}?${i}`:e,c=g("shareUrl");c&&(c.value=s)}async function R(e){const n=await fetch(e,{headers:{Accept:"application/fhir+json"}});if(!n.ok)throw new Error(`HTTP ${n.status} for ${e}`);return n.json()}function Q(e){return!e||e.resourceType!=="Bundle"?[]:(e.entry||[]).map(n=>n&&(n.resource||n)).filter(Boolean)}function F(e){return(Array.isArray(e.name)?e.name.map(t=>[t.prefix,t.given,t.family].flat().filter(Boolean).join(" ")).filter(Boolean):[])[0]||"(ohne Name)"}function T(e){const n=[];e.id&&n.push(["ID",e.id]),e.birthDate&&n.push(["Geburtsdatum",e.birthDate]),e.gender&&n.push(["Geschlecht",e.gender]);const t=Array.isArray(e.identifier)?e.identifier.map(i=>`${i.system||""}|${i.value||""}`).filter(Boolean):[];return t.length&&n.push(["Identifier",t.join(", ")]),n}function N(e){return e.name||e.description||"(Account)"}function H(e){const n=[];e.id&&n.push(["ID",e.id]),e.status&&n.push(["Status",e.status]);const t=Array.isArray(e.identifier)?e.identifier.map(i=>`${i.system||""}|${i.value||""}`).filter(Boolean):[];return t.length&&n.push(["Identifier",t.join(", ")]),n}function K(e){return e.title||e.name||e.id||"(Questionnaire)"}function G(e){const n=[];return e.id&&n.push(["ID",e.id]),e.version&&n.push(["Version",e.version]),e.url&&n.push(["URL",e.url]),e.description&&n.push(["Beschreibung",{html:V(String(e.description)),markdown:!0,block:!0}]),n}function q(e,n,t,i,s){const c=g(e);if(!c||(c.replaceChildren(),!t||t.length===0))return;const m=document.createElement("div");m.className="result-title",m.textContent=`${n} – mehrere Treffer, bitte wählen:`,c.appendChild(m);const b=p=>s==="Patient"?[F(p),T(p)]:s==="Account"?[N(p),H(p)]:[K(p),G(p)];t.forEach(p=>{const[y,v]=b(p),u=document.createElement("div");u.className="pick-panel",u.setAttribute("role","button"),u.setAttribute("tabindex","0");const o=document.createElement("h3");o.textContent=y;const r=document.createElement("div");r.className="inner";const a=document.createElement("div");a.className="kv",v.forEach(([f,d])=>{const A=d&&typeof d=="object"&&d.block,P=document.createElement("div");P.className="k"+(A?" block":""),P.textContent=f;const w=document.createElement("div");w.className="v"+(A?" block":""),d&&typeof d=="object"&&d.html?(w.classList.add("markdown"),d.markdown&&w.classList.add("desc"),w.innerHTML=d.html):w.textContent=String(d??""),a.appendChild(P),a.appendChild(w)}),r.appendChild(a),u.appendChild(o),u.appendChild(r),u.onclick=()=>i(p),u.onkeydown=f=>{(f.key==="Enter"||f.key===" ")&&(f.preventDefault(),i(p))},c.appendChild(u)})}function W(){["patientResults","accountResults","questionnaireResults"].forEach(e=>{const n=g(e);n&&n.replaceChildren()})}function z(e){const n=new URL("index.html",window.location.href),t=new URLSearchParams;return e.q&&t.set("q",e.q),e.base&&t.set("base",e.base),e.id&&t.set("id",e.id),e.prepopBase&&t.set("prepopBase",e.prepopBase),e.patient&&t.set("patient",e.patient),e.encounter&&t.set("encounter",e.encounter),e.user&&t.set("user",e.user),e.account&&t.set("account",e.account),e.minimal==="true"&&t.set("minimal","true"),n.search=t.toString(),n.toString()}async function S(e){W();const n=e.base,t=e.prepopBase||e.base;if(!n&&!t){l("Bitte FHIR Base angeben.","err");return}l("Suche wird ausgeführt …");const i={...e},s=!i.q&&!i.id&&!!i.qCanonical,c=!i.patient&&!!i.pid,m=!!i.fid,b=k&&String(k).toLowerCase().startsWith("q")||!s&&!c&&!m&&k&&String(k).toLowerCase()!=="patient",p=k&&String(k).toLowerCase().startsWith("p"),y=[];if(c){const o=$(n,`Patient?identifier=${encodeURIComponent(i.pid)}`);y.push(R(o).then(r=>({key:"patient",bundle:r})).catch(r=>({key:"patient",error:r})))}if(m){const o=$(n,`Account?identifier=${encodeURIComponent(i.fid)}`);y.push(R(o).then(r=>({key:"account",bundle:r})).catch(r=>({key:"account",error:r})))}if(s){let o=i.qCanonical,r=null;if(o.includes("|")){const[d,A]=o.split("|");o=d,r=A}const a=r?`Questionnaire?url=${encodeURIComponent(o)}&version=${encodeURIComponent(r)}`:`Questionnaire?url=${encodeURIComponent(o)}`,f=$(n,a);y.push(R(f).then(d=>({key:"questionnaire",bundle:d})).catch(d=>({key:"questionnaire",error:d})))}if(b){const r=$(n,"Questionnaire?_count=100&_elements=id,title,name,version,description,url");y.push(E(r).then(a=>({key:"questionnaireAll",items:a})).catch(a=>({key:"questionnaireAll",error:a})))}if(p){const a=$(t||n,"Patient?_count=100&_elements=id,name,birthDate,gender,identifier");y.push(E(a).then(f=>({key:"patientAll",items:f})).catch(f=>({key:"patientAll",error:f})))}const v=await Promise.all(y);let u=!1;for(const o of v){if(o.error){l(`Fehler bei ${o.key}-Suche: ${o.error.message}`,"err");return}const r=Q(o.bundle);if(o.key==="patient"){if(r.length===0){l("Kein Patient für pid gefunden.","err");return}r.length===1?i.patient=r[0].id:(u=!0,q("patientResults","Patient",r,a=>{i.patient=a.id,C(i)},"Patient"))}if(o.key==="account"){if(r.length===0){l("Kein Account für fid gefunden.","err");return}r.length===1?i.account=r[0].id:(u=!0,q("accountResults","Account",r,a=>{i.account=a.id,C(i)},"Account"))}if(o.key==="questionnaire"){if(r.length===0){l("Kein Questionnaire für qCanonical gefunden.","err");return}r.length===1?i.id=r[0].id:(u=!0,q("questionnaireResults","Questionnaire",r,a=>{i.id=a.id,C(i)},"Questionnaire"))}if(o.key==="questionnaireAll"){if(o.error){l(`Fehler beim Laden aller Questionnaires: ${o.error.message}`,"err");return}const a=o.items||[];if(a.length===0){l("Keine Questionnaires gefunden.","err");return}u=!0,q("questionnaireResults","Questionnaires",a,f=>{i.id=f.id,C(i)},"Questionnaire")}if(o.key==="patientAll"){if(o.error){l(`Fehler beim Laden aller Patienten: ${o.error.message}`,"err");return}const a=o.items||[];if(a.length===0){l("Keine Patienten gefunden.","err");return}u=!0,q("patientResults","Patienten",a,f=>{i.patient=f.id,C(i)},"Patient")}}u?l("Bitte eine Auswahl treffen, dann wird weitergeleitet …","ok"):C(i)}function C(e){const n=[];if(e.pid&&!e.patient&&n.push("patient"),e.fid&&!e.account&&n.push("account"),e.qCanonical&&!e.q&&!e.id&&n.push("questionnaire"),n.length>0)return;if(e.id&&e.base)e.q=void 0;else if(!(!e.id&&e.q)){if(e.id&&!e.base){l("Questionnaire-ID vorhanden, aber kein base-Parameter. Bitte base setzen.","err");return}}const t=z(e);l("Weiterleitung zur Formular-Seite …","ok"),window.location.assign(t)}(function(){const n=x();B(),["base","prepopBase","pid","fid","qCanonical","patient","encounter","user","id","q"].forEach(s=>{const c=g(s);c&&c.addEventListener("input",B)});const t=g("btnCopyUrl");t&&(t.onclick=async()=>{try{const s=g("shareUrl")?.value||"";if(!s)return l("Kein Link vorhanden.","err");await navigator.clipboard.writeText(s),l("Link kopiert.","ok")}catch{l("Kopieren fehlgeschlagen.","err")}});const i=g("btnRun");i&&(i.onclick=async()=>{try{const s={...n,...L()};Object.keys(s).forEach(c=>{s[c]===""&&delete s[c]}),await S(s)}catch(s){l(s.message,"err")}}),n.base&&(n.pid||n.fid||n.qCanonical||k)?S(n):l("Parameter prüfen und ggf. „Suchen“ klicken …")})();function M(e){return e.replace(/[&<>]/g,n=>({"&":"&amp;","<":"&lt;",">":"&gt;"})[n])}function V(e){if(!e)return"";let n=String(e).replace(/\r\n/g,`
`);return n=M(n),n=n.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(t,i,s)=>{try{return`<a href="${/^https?:/i.test(s)?s:"#"}" target="_blank" rel="noopener noreferrer">${i}</a>`}catch{return i}}),n=n.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/__([^_]+)__/g,"<strong>$1</strong>"),n=n.replace(new RegExp("(?<!\\*)\\*([^*]+)\\*(?!\\*)","g"),"<em>$1</em>").replace(new RegExp("(?<!_)_([^_]+)_(?!_)","g"),"<em>$1</em>"),n=n.replace(/`([^`]+)`/g,"<code>$1</code>"),n=n.replace(/^#{1,6}\s*(.+)$/gm,"<strong>$1</strong>"),n=n.replace(/\n/g,"<br>"),n}async function E(e,n=1e3){const t=[];let i=e,s=0;for(;i&&s<n;){const c=await R(i);t.push(...Q(c));const m=(c.link||[]).find(b=>b.relation==="next")?.url;i=m?$(new URL(e).origin,m):null,s+=1}return t}
