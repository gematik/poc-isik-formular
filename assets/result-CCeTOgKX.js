import"./modulepreload-polyfill-B5Qt9EMX.js";import"./footer-z8lHOjHC.js";function D(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function N(e){return Array.isArray(e)?e:e==null?[]:[e]}function o(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function C(e){return{status:"extensions",div:`<div xmlns="http://www.w3.org/1999/xhtml">${e}</div>`}}function T(e){if(!e)return"";const t=Array.isArray(e)?e[0]:e;return t?.display||t?.code||""}function L(e){return(Array.isArray(e?.name)?e.name:[])[0]?.family||""}function O(e){const t=Array.isArray(e?.identifier)?e.identifier:[];for(const n of t)if((n?.type?.coding||[]).some(a=>(a.code||"").toLowerCase()==="pid"))return n.value||"";for(const n of t)if((n.system||"").toLowerCase().includes("pid"))return n.value||"";return t.length&&t[0].value||""}function Q(e,t){const n=t?.patient||null,r=t?.subjectRefStr||"",a=t?.authorDisplay||"",l=n?L(n):"",i=n?.birthDate||"";let u=n?O(n):"";if(!u&&r){const y=r.match(/(^|\/)Patient\/([^\/?#]+)/i);u=y&&y[2]||""}const d=`
    <h2>Dokumenten-Header</h2>
    <table class="grid">${[`<tr><th>Patient (Familienname)</th><td>${o(l)}</td></tr>`,`<tr><th>Geburtsdatum</th><td>${o(i)}</td></tr>`,`<tr><th>Patienten-ID (pid)</th><td>${o(u)}</td></tr>`,`<tr><th>Status</th><td>${o(e.status||"")}</td></tr>`,`<tr><th>Dokumenttyp</th><td>${o(e.type?.text||"")}</td></tr>`,`<tr><th>Datum</th><td>${o(e.date||"")}</td></tr>`,`<tr><th>Titel</th><td>${o(e.title||"")}</td></tr>`,`<tr><th>Autor</th><td>${o(a)}</td></tr>`].join("")}</table>
  `;return C(d)}function K(e){return typeof e=="string"&&/^-?\d+(?:[\.,]\d+)?(?:[eE][+-]?\d+)?$/.test(e.trim())}function A(e){if(e&&K(e.value)){const t=e.value.replace(",","."),n=Number(t);Number.isNaN(n)||(e.value=n)}}function P(e){if(!e||e.resourceType!=="Observation")return e;if(Object.prototype.hasOwnProperty.call(e,"derivedFrom"))try{delete e.derivedFrom}catch{}return e.valueQuantity&&A(e.valueQuantity),Array.isArray(e.component)&&e.component.forEach(t=>{t.valueQuantity&&A(t.valueQuantity)}),e}function F(e,t){if(!e||!t)return;const n={url:"http://hl7.org/fhir/StructureDefinition/display",valueString:String(t)};e._questionnaire=e._questionnaire||{};const r=Array.isArray(e._questionnaire.extension)?e._questionnaire.extension:[],a=r.findIndex(l=>l&&l.url===n.url);a>=0?r[a]={...r[a],valueString:n.valueString}:r.push(n),e._questionnaire.extension=r}function z(e){return e?e.valueString!=null||e.valueBoolean!=null||e.valueInteger!=null||e.valueDecimal!=null||e.valueCodeableConcept!=null||e.valueQuantity!=null||e.valueDateTime!=null||e.valueDate!=null||e.valueTime!=null:!1}function B(e){return e?.code?.text||T(e?.code?.coding)||`Observation ${e?.id||""}`.trim()}function R(e){if(!e)return"";const t=e.value!=null?e.value:"",n=e.unit||e.code||e.system||"";return`${t} ${n}`.trim()}function U(e){return e?e.valueString!=null?o(e.valueString):e.valueBoolean!=null?e.valueBoolean?"ja":"nein":e.valueInteger!=null?String(e.valueInteger):e.valueDecimal!=null?String(e.valueDecimal):e.valueCodeableConcept?o(e.valueCodeableConcept.text||T(e.valueCodeableConcept.coding)):e.valueQuantity?o(R(e.valueQuantity)):e.valueDateTime?o(e.valueDateTime):e.valueDate?o(e.valueDate):e.valueTime?o(e.valueTime):"":""}function w(e){const t=o(B(e)),n=e.effectiveDateTime||e.effectivePeriod?.start||"",r=e.performer&&e.performer[0]?.display||"",a=U(e),l=[a?`<tr><th>Wert</th><td>${o(a)}</td></tr>`:"",n?`<tr><th>Erhoben am</th><td>${o(n)}</td></tr>`:"",r?`<tr><th>Erhoben von</th><td>${o(r)}</td></tr>`:""].filter(Boolean).join(""),i=`
    <h2>${t}</h2>
    <table class="grid">
      ${l||'<tr><td colspan="2">(keine Details)</td></tr>'}
    </table>
  `;return C(i)}function M(e){return e?e.valueString!=null?o(e.valueString):e.valueBoolean!=null?e.valueBoolean?"ja":"nein":e.valueInteger!=null?String(e.valueInteger):e.valueDecimal!=null?String(e.valueDecimal):e.valueDate?o(e.valueDate):e.valueDateTime?o(e.valueDateTime):e.valueTime?o(e.valueTime):e.valueCoding?o(e.valueCoding.display||e.valueCoding.code||""):e.valueQuantity?o(R(e.valueQuantity)):e.valueReference?o(e.valueReference.display||e.valueReference.reference||""):"":""}function j(e,t){Array.isArray(e)&&e.forEach(n=>{const r=o(n.text||n.linkId||""),a=(n.answer||[]).map(l=>M(l)).filter(Boolean).join(", ");(r||a)&&t.push(`<li><strong>${r}:</strong> ${a||"—"}</li>`),n.item&&j(n.item,t)})}function I(e){const t=[e.status?`<tr><th>Status</th><td>${o(e.status)}</td></tr>`:"",e.authored?`<tr><th>Erstellt</th><td>${o(e.authored)}</td></tr>`:"",e.subject?.display||e.subject?.reference?`<tr><th>Patient</th><td>${o(e.subject.display||e.subject.reference)}</td></tr>`:""].filter(Boolean).join(""),n=[];j(e.item,n);const r=`
    <h2>Fragebogen</h2>
    <table class="grid">${t}</table>
    ${n.length?`<ul>${n.join("")}</ul>`:"<div>(keine Antworten)</div>"}
  `;return C(r)}function H(e){if(e&&e.subject&&typeof e.subject=="object")return{reference:e.subject.reference,display:e.subject.display};if(e&&typeof e.subject=="string")return{reference:e.subject}}function J(e){if(e&&e.encounter&&typeof e.encounter=="object")return{reference:e.encounter.reference,display:e.encounter.display};if(e&&typeof e.encounter=="string")return{reference:e.encounter}}function _(e){const t=e?.questionnaireResponse,n=N(e?.observations).filter(Boolean).map(P).filter(z);if(!t||t.resourceType!=="QuestionnaireResponse")return null;const r=e?.meta?.generatedAt||new Date().toISOString(),a=D(),l=D(),i=t.id||l;t.id||(t.id=i);const u=n.map(s=>s?.id||D());let f="LHC-Forms Demo App";t&&t.author&&(typeof t.author=="object"?f=t.author.display||t.author.reference||f:typeof t.author=="string"&&(f=t.author||f));const d=H(t),y=J(t);let m=null,h=null;const x=d?.reference||(typeof d=="string"?d:null);if(x){const s=x.match(/(^|\/)Patient\/([^\/?#]+)/i),c=s&&s[2];if(c){const E=`Patient/${c}`;m={fullUrl:E,resource:{resourceType:"Patient",id:c,identifier:[{system:"urn:source-id",value:c}]}},h={reference:E}}}const p=`Composition/${a}`,S=`QuestionnaireResponse/${i}`,v={resourceType:"Composition",id:a,status:"final",identifier:{system:"urn:ietf:rfc:3986",value:`urn:uuid:${a}`},meta:{profile:["https://gematik.de/fhir/isik/StructureDefinition/ISiKBerichtSubSysteme"]},type:{coding:[{system:"http://dvmd.de/fhir/CodeSystem/kdl",code:"AM170103",display:"Patientenfragebogen"}],text:"AM170103 - Patientenfragebogen"},date:r,title:"ISiK Bericht",...h||d?{subject:h||d}:{},...y?{encounter:y}:{},author:[{display:f}],section:[{title:"QuestionnaireResponse",text:I(t),entry:[{reference:S}]},...n.map((s,c)=>({title:B(s),text:w(s),entry:[{reference:`Observation/${u[c]}`}]}))]};try{const s=h?.reference||d?.reference||(typeof d=="string"?d:"")||"";v.text=Q(v,{patient:m?.resource||null,subjectRefStr:s,authorDisplay:f})}catch{}const g={resourceType:"Bundle",type:"document",timestamp:r,identifier:{system:"urn:ietf:rfc:3986",value:`urn:uuid:${D()}`},meta:{profile:["https://gematik.de/fhir/isik/StructureDefinition/ISiKBerichtBundle"]},entry:[{fullUrl:p,resource:v},...m?[m]:[],{fullUrl:S,resource:t},...n.map((s,c)=>({fullUrl:`Observation/${u[c]}`,resource:{...s||{},id:u[c]}}))]};try{t.text=I(t);const s=e?.meta?.questionnaireTitle;s&&F(t,s),t.meta=t.meta||{};const c=Array.isArray(t.meta.profile)?t.meta.profile.slice():[];c.includes("https://gematik.de/fhir/isik/StructureDefinition/ISiKFormularDaten")||c.push("https://gematik.de/fhir/isik/StructureDefinition/ISiKFormularDaten"),t.meta.profile=c}catch{}return n.forEach((s,c)=>{try{s.text=w(s)}catch{}}),g}const b=e=>document.getElementById(e);function G(e){return new URLSearchParams(window.location.search).get(e)}function V(){const e=G("k");if(!e)return{error:"Kein Schlüssel (k) in URL gefunden."};try{const t=localStorage.getItem(e);if(!t)return{error:"Keine Exportdaten im localStorage gefunden."};const n=JSON.parse(t);try{localStorage.removeItem(e)}catch{}return{data:n}}catch(t){return{error:"Fehler beim Laden/Parsen der Exportdaten: "+t.message}}}function $(e){try{return JSON.stringify(e,null,2)}catch{return String(e)}}function W(e){const t=b("tabs");if(!t)return;t.replaceChildren();const n=document.createElement("div");n.className="tab-list";const r=document.createElement("div");r.className="tab-panels";const a=i=>"tab-"+i;e.forEach((i,u)=>{const f=document.createElement("button");f.className="tab-btn";const d=(()=>{try{return i?.resourceType!=="Bundle"?!1:Array.isArray(i?.meta?.profile)&&i.meta.profile.includes("https://gematik.de/fhir/isik/StructureDefinition/ISiKBerichtBundle")?!0:(i?.meta?.tag||[]).some(s=>s?.code==="isik-bundle")}catch{return!1}})(),y=d?"ISiKBerichtBundle":i&&i.resourceType?`${i.resourceType}${i.id?" #"+i.id:""}`:`Resource ${u+1}`;f.textContent=y,f.setAttribute("data-for",a(u)),n.appendChild(f);const m=document.createElement("div");m.className="tab-panel",m.id=a(u);const h=document.createElement("div");h.className="panel-actions";const x=document.createElement("div");x.className="hint",x.textContent=y;const p=document.createElement("button");p.className="btn small secondary",p.textContent="JSON kopieren",p.onclick=async()=>{try{await navigator.clipboard.writeText($(i)),p.textContent="Kopiert!",setTimeout(()=>p.textContent="JSON kopieren",1200)}catch{p.textContent="Fehler",setTimeout(()=>p.textContent="JSON kopieren",1200)}},h.appendChild(x),h.appendChild(p);const S=(()=>{try{if(i?.resourceType==="Bundle"&&i?.type==="document"&&(i?.meta?.tag||[]).some(c=>c?.code==="isik-bundle")){const c=document.createElement("div");return c.className="hint",c.textContent="Aus Demogründen wurde der KDL Typ 'AM170103 - Patientenfragebogen' für die Composition gewählt. Hier muss natürlich ein passender Code gesetzt werden",c}}catch{}return null})(),v=document.createElement("pre");if(v.className="json-box",v.textContent=$(i),m.appendChild(h),S&&m.appendChild(S),!S&&d){const g=document.createElement("div");g.className="hint",g.textContent="Aus Demogründen wurde der KDL Typ 'AM170103 - Patientenfragebogen' für die Composition gewählt. Hier muss natürlich ein passender Code gesetzt werden",m.appendChild(g)}m.appendChild(v),r.appendChild(m)}),t.appendChild(n),t.appendChild(r);const l=i=>{Array.from(t.querySelectorAll(".tab-btn")).forEach(u=>u.classList.toggle("active",u.getAttribute("data-for")===i)),Array.from(t.querySelectorAll(".tab-panel")).forEach(u=>u.classList.toggle("active",u.id===i))};n.addEventListener("click",i=>{const u=i.target.closest(".tab-btn");u&&l(u.getAttribute("data-for"))}),e.length>0&&l("tab-0"),t.classList.remove("hidden")}function k(e){const t=b("metaLine"),n=e?.meta||{},r=[];n.generatedAt&&r.push("Erzeugt: "+new Date(n.generatedAt).toLocaleString()),n.type==="templateExtract"?r.push(n.templateExtractSuccess===!1?"Template-Extract (OperationOutcome)":"Template-Extract Bundle"):n.includeObservations===!0?r.push("Inklusive Observations"):n.includeObservations===!1&&r.push("Nur QuestionnaireResponse"),n.questionnaireTitle?r.push("Questionnaire: "+n.questionnaireTitle):n.questionnaireId&&r.push("Questionnaire-ID: "+n.questionnaireId),t.textContent=r.length>0?r.join(" | "):"Keine Metadaten vorhanden.",n.type==="templateExtract"&&n.templateExtractSuccess===!1?t.classList.add("err"):t.classList.remove("err");const a=[];e?.questionnaireResponse&&a.push(e.questionnaireResponse),Array.isArray(e?.observations)&&a.push(...e.observations),e?.templateExtractBundle&&a.push(e.templateExtractBundle),e?.templateExtractIssues&&a.push(e.templateExtractIssues),e?.templateExtractOutcome&&a.push(e.templateExtractOutcome),e?.templateExtractDebugInfo&&a.push(e.templateExtractDebugInfo);try{const l=_({questionnaireResponse:e?.questionnaireResponse,observations:e?.observations,meta:e?.meta});l&&a.push(l)}catch(l){console.warn("ISiK BerichtsBundle konnte nicht erzeugt werden:",l?.message||l)}if(a.length===0){b("emptyMsg").textContent="Keine Ressourcen vorhanden.";return}W(a)}(function(){const{data:t,error:n}=V(),r=b("metaLine");if(n){r.textContent="Warte auf Exportdaten …",r.classList.remove("err");let a=!1;const l=i=>{try{if(!i||!i.data||i.origin!==window.location.origin||i.data?.type!=="lhc-export")return;a=!0,window.removeEventListener("message",l);const u=i.data?.payload;if(!u)throw new Error("Keine Nutzdaten empfangen.");k(u)}catch(u){r.textContent="Exportdaten konnten nicht empfangen werden: "+(u?.message||u),r.classList.add("err"),b("emptyMsg").textContent="Keine Daten zum Anzeigen."}};window.addEventListener("message",l),setTimeout(()=>{a||(r.textContent=n||"Keine Daten gefunden.",r.classList.add("err"),b("emptyMsg").textContent="Keine Daten zum Anzeigen.")},5e3);return}k(t)})();
