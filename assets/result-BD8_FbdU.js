import"./footer-BcjiCzmm.js";function C(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function N(e){return Array.isArray(e)?e:e==null?[]:[e]}function o(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function D(e){return{status:"extensions",div:`<div xmlns="http://www.w3.org/1999/xhtml">${e}</div>`}}function T(e){if(!e)return"";const t=Array.isArray(e)?e[0]:e;return t?.display||t?.code||""}function L(e){return(Array.isArray(e?.name)?e.name:[])[0]?.family||""}function Q(e){const t=Array.isArray(e?.identifier)?e.identifier:[];for(const n of t)if((n?.type?.coding||[]).some(a=>(a.code||"").toLowerCase()==="pid"))return n.value||"";for(const n of t)if((n.system||"").toLowerCase().includes("pid"))return n.value||"";return t.length&&t[0].value||""}function K(e,t){const n=t?.patient||null,r=t?.subjectRefStr||"",a=t?.authorDisplay||"",c=n?L(n):"",i=n?.birthDate||"";let u=n?Q(n):"";if(!u&&r){const y=r.match(/(^|\/)Patient\/([^\/?#]+)/i);u=y&&y[2]||""}const d=`
    <h2>Dokumenten-Header</h2>
    <table class="grid">${[`<tr><th>Patient (Familienname)</th><td>${o(c)}</td></tr>`,`<tr><th>Geburtsdatum</th><td>${o(i)}</td></tr>`,`<tr><th>Patienten-ID (pid)</th><td>${o(u)}</td></tr>`,`<tr><th>Status</th><td>${o(e.status||"")}</td></tr>`,`<tr><th>Dokumenttyp</th><td>${o(e.type?.text||"")}</td></tr>`,`<tr><th>Datum</th><td>${o(e.date||"")}</td></tr>`,`<tr><th>Titel</th><td>${o(e.title||"")}</td></tr>`,`<tr><th>Autor</th><td>${o(a)}</td></tr>`].join("")}</table>
  `;return D(d)}function O(e){return typeof e=="string"&&/^-?\d+(?:[\.,]\d+)?(?:[eE][+-]?\d+)?$/.test(e.trim())}function w(e){if(e&&O(e.value)){const t=e.value.replace(",","."),n=Number(t);Number.isNaN(n)||(e.value=n)}}function P(e){if(!e||e.resourceType!=="Observation")return e;if(Object.prototype.hasOwnProperty.call(e,"derivedFrom"))try{delete e.derivedFrom}catch{}return e.valueQuantity&&w(e.valueQuantity),Array.isArray(e.component)&&e.component.forEach(t=>{t.valueQuantity&&w(t.valueQuantity)}),e}function F(e,t){if(!e||!t)return;const n={url:"http://hl7.org/fhir/StructureDefinition/display",valueString:String(t)};e._questionnaire=e._questionnaire||{};const r=Array.isArray(e._questionnaire.extension)?e._questionnaire.extension:[],a=r.findIndex(c=>c&&c.url===n.url);a>=0?r[a]={...r[a],valueString:n.valueString}:r.push(n),e._questionnaire.extension=r}function z(e){return e?e.valueString!=null||e.valueBoolean!=null||e.valueInteger!=null||e.valueDecimal!=null||e.valueCodeableConcept!=null||e.valueQuantity!=null||e.valueDateTime!=null||e.valueDate!=null||e.valueTime!=null:!1}function R(e){return e?.code?.text||T(e?.code?.coding)||`Observation ${e?.id||""}`.trim()}function j(e){if(!e)return"";const t=e.value!=null?e.value:"",n=e.unit||e.code||e.system||"";return`${t} ${n}`.trim()}function U(e){return e?e.valueString!=null?o(e.valueString):e.valueBoolean!=null?e.valueBoolean?"ja":"nein":e.valueInteger!=null?String(e.valueInteger):e.valueDecimal!=null?String(e.valueDecimal):e.valueCodeableConcept?o(e.valueCodeableConcept.text||T(e.valueCodeableConcept.coding)):e.valueQuantity?o(j(e.valueQuantity)):e.valueDateTime?o(e.valueDateTime):e.valueDate?o(e.valueDate):e.valueTime?o(e.valueTime):"":""}function $(e){const t=o(R(e)),n=e.effectiveDateTime||e.effectivePeriod?.start||"",r=e.performer&&e.performer[0]?.display||"",a=U(e),c=[a?`<tr><th>Wert</th><td>${o(a)}</td></tr>`:"",n?`<tr><th>Erhoben am</th><td>${o(n)}</td></tr>`:"",r?`<tr><th>Erhoben von</th><td>${o(r)}</td></tr>`:""].filter(Boolean).join(""),i=`
    <h2>${t}</h2>
    <table class="grid">
      ${c||'<tr><td colspan="2">(keine Details)</td></tr>'}
    </table>
  `;return D(i)}function M(e){return e?e.valueString!=null?o(e.valueString):e.valueBoolean!=null?e.valueBoolean?"ja":"nein":e.valueInteger!=null?String(e.valueInteger):e.valueDecimal!=null?String(e.valueDecimal):e.valueDate?o(e.valueDate):e.valueDateTime?o(e.valueDateTime):e.valueTime?o(e.valueTime):e.valueCoding?o(e.valueCoding.display||e.valueCoding.code||""):e.valueQuantity?o(j(e.valueQuantity)):e.valueReference?o(e.valueReference.display||e.valueReference.reference||""):"":""}function B(e,t){Array.isArray(e)&&e.forEach(n=>{const r=o(n.text||n.linkId||""),a=(n.answer||[]).map(c=>M(c)).filter(Boolean).join(", ");(r||a)&&t.push(`<li><strong>${r}:</strong> ${a||"—"}</li>`),n.item&&B(n.item,t)})}function k(e){const t=[e.status?`<tr><th>Status</th><td>${o(e.status)}</td></tr>`:"",e.authored?`<tr><th>Erstellt</th><td>${o(e.authored)}</td></tr>`:"",e.subject?.display||e.subject?.reference?`<tr><th>Patient</th><td>${o(e.subject.display||e.subject.reference)}</td></tr>`:""].filter(Boolean).join(""),n=[];B(e.item,n);const r=`
    <h2>Fragebogen</h2>
    <table class="grid">${t}</table>
    ${n.length?`<ul>${n.join("")}</ul>`:"<div>(keine Antworten)</div>"}
  `;return D(r)}function H(e){if(e&&e.subject&&typeof e.subject=="object")return{reference:e.subject.reference,display:e.subject.display};if(e&&typeof e.subject=="string")return{reference:e.subject}}function J(e){if(e&&e.encounter&&typeof e.encounter=="object")return{reference:e.encounter.reference,display:e.encounter.display};if(e&&typeof e.encounter=="string")return{reference:e.encounter}}function _(e){const t=e?.questionnaireResponse,n=N(e?.observations).filter(Boolean).map(P).filter(z);if(!t||t.resourceType!=="QuestionnaireResponse")return null;const r=e?.meta?.generatedAt||new Date().toISOString(),a=C(),c=C(),i=t.id||c;t.id||(t.id=i);const u=n.map(l=>l?.id||C());let f="LHC-Forms Demo App";t&&t.author&&(typeof t.author=="object"?f=t.author.display||t.author.reference||f:typeof t.author=="string"&&(f=t.author||f));const d=H(t),y=J(t);let m=null,h=null;const x=d?.reference||(typeof d=="string"?d:null);if(x){const l=x.match(/(^|\/)Patient\/([^\/?#]+)/i),s=l&&l[2];if(s){const A=`Patient/${s}`;m={fullUrl:A,resource:{resourceType:"Patient",id:s,identifier:[{system:"urn:source-id",value:s}]}},h={reference:A}}}const p=`Composition/${a}`,S=`QuestionnaireResponse/${i}`,v={resourceType:"Composition",id:a,status:"final",identifier:{system:"urn:ietf:rfc:3986",value:`urn:uuid:${a}`},meta:{profile:["https://gematik.de/fhir/isik/StructureDefinition/ISiKBerichtSubSysteme"]},type:{coding:[{system:"http://dvmd.de/fhir/CodeSystem/kdl",code:"AM170103",display:"Patientenfragebogen"}],text:"AM170103 - Patientenfragebogen"},date:r,title:"ISiK Bericht",...h||d?{subject:h||d}:{},...y?{encounter:y}:{},author:[{display:f}],section:[{title:"QuestionnaireResponse",text:k(t),entry:[{reference:S}]},...n.map((l,s)=>({title:R(l),text:$(l),entry:[{reference:`Observation/${u[s]}`}]}))]};try{const l=h?.reference||d?.reference||(typeof d=="string"?d:"")||"";v.text=K(v,{patient:m?.resource||null,subjectRefStr:l,authorDisplay:f})}catch{}const g={resourceType:"Bundle",type:"document",timestamp:r,identifier:{system:"urn:ietf:rfc:3986",value:`urn:uuid:${C()}`},meta:{profile:["https://gematik.de/fhir/isik/StructureDefinition/ISiKBerichtBundle"]},entry:[{fullUrl:p,resource:v},...m?[m]:[],{fullUrl:S,resource:t},...n.map((l,s)=>({fullUrl:`Observation/${u[s]}`,resource:{...l||{},id:u[s]}}))]};try{t.text=k(t);const l=e?.meta?.questionnaireTitle;l&&F(t,l),t.meta=t.meta||{};const s=Array.isArray(t.meta.profile)?t.meta.profile.slice():[];s.includes("https://gematik.de/fhir/isik/StructureDefinition/ISiKFormularDaten")||s.push("https://gematik.de/fhir/isik/StructureDefinition/ISiKFormularDaten"),t.meta.profile=s}catch{}return n.forEach((l,s)=>{try{l.text=$(l)}catch{}}),g}const b=e=>document.getElementById(e);function G(e){return new URLSearchParams(window.location.search).get(e)}function V(){const e=G("k");if(!e)return{error:"Kein Schlüssel (k) in URL gefunden."};try{const t=localStorage.getItem(e);if(!t)return{error:"Keine Exportdaten im localStorage gefunden."};const n=JSON.parse(t);try{localStorage.removeItem(e)}catch{}return{data:n}}catch(t){return{error:"Fehler beim Laden/Parsen der Exportdaten: "+t.message}}}function E(e){try{return JSON.stringify(e,null,2)}catch{return String(e)}}function W(e){const t=b("tabs");if(!t)return;t.replaceChildren();const n=document.createElement("div");n.className="tab-list";const r=document.createElement("div");r.className="tab-panels";const a=i=>"tab-"+i;e.forEach((i,u)=>{const f=document.createElement("button");f.className="tab-btn";const d=(()=>{try{return i?.resourceType!=="Bundle"?!1:Array.isArray(i?.meta?.profile)&&i.meta.profile.includes("https://gematik.de/fhir/isik/StructureDefinition/ISiKBerichtBundle")?!0:(i?.meta?.tag||[]).some(l=>l?.code==="isik-bundle")}catch{return!1}})(),y=d?"ISiKBerichtBundle":i&&i.resourceType?`${i.resourceType}${i.id?" #"+i.id:""}`:`Resource ${u+1}`;f.textContent=y,f.setAttribute("data-for",a(u)),n.appendChild(f);const m=document.createElement("div");m.className="tab-panel",m.id=a(u);const h=document.createElement("div");h.className="panel-actions";const x=document.createElement("div");x.className="hint",x.textContent=y;const p=document.createElement("button");p.className="btn small secondary",p.textContent="JSON kopieren",p.onclick=async()=>{try{await navigator.clipboard.writeText(E(i)),p.textContent="Kopiert!",setTimeout(()=>p.textContent="JSON kopieren",1200)}catch{p.textContent="Fehler",setTimeout(()=>p.textContent="JSON kopieren",1200)}},h.appendChild(x),h.appendChild(p);const S=(()=>{try{if(i?.resourceType==="Bundle"&&i?.type==="document"&&(i?.meta?.tag||[]).some(s=>s?.code==="isik-bundle")){const s=document.createElement("div");return s.className="hint",s.textContent="Aus Demogründen wurde der KDL Typ 'AM170103 - Patientenfragebogen' für die Composition gewählt. Hier muss natürlich ein passender Code gesetzt werden",s}}catch{}return null})(),v=document.createElement("pre");if(v.className="json-box",v.textContent=E(i),m.appendChild(h),S&&m.appendChild(S),!S&&d){const g=document.createElement("div");g.className="hint",g.textContent="Aus Demogründen wurde der KDL Typ 'AM170103 - Patientenfragebogen' für die Composition gewählt. Hier muss natürlich ein passender Code gesetzt werden",m.appendChild(g)}m.appendChild(v),r.appendChild(m)}),t.appendChild(n),t.appendChild(r);const c=i=>{Array.from(t.querySelectorAll(".tab-btn")).forEach(u=>u.classList.toggle("active",u.getAttribute("data-for")===i)),Array.from(t.querySelectorAll(".tab-panel")).forEach(u=>u.classList.toggle("active",u.id===i))};n.addEventListener("click",i=>{const u=i.target.closest(".tab-btn");u&&c(u.getAttribute("data-for"))}),e.length>0&&c("tab-0"),t.classList.remove("hidden")}function I(e){const t=b("metaLine"),n=[];e?.meta?.generatedAt&&n.push("Erzeugt: "+new Date(e.meta.generatedAt).toLocaleString()),e?.meta?.includeObservations?n.push("Inklusive Observations"):n.push("Nur QuestionnaireResponse"),t.textContent=n.join(" | ");const r=[];e?.questionnaireResponse&&r.push(e.questionnaireResponse),Array.isArray(e?.observations)&&r.push(...e.observations);try{const a=_({questionnaireResponse:e?.questionnaireResponse,observations:e?.observations,meta:e?.meta});a&&r.push(a)}catch(a){console.warn("ISiK BerichtsBundle konnte nicht erzeugt werden:",a?.message||a)}if(r.length===0){b("emptyMsg").textContent="Keine Ressourcen vorhanden.";return}W(r)}(function(){const{data:t,error:n}=V(),r=b("metaLine");if(n){r.textContent="Warte auf Exportdaten …",r.classList.remove("err");let a=!1;const c=i=>{try{if(!i||!i.data||i.origin!==window.location.origin||i.data?.type!=="lhc-export")return;a=!0,window.removeEventListener("message",c);const u=i.data?.payload;if(!u)throw new Error("Keine Nutzdaten empfangen.");I(u)}catch(u){r.textContent="Exportdaten konnten nicht empfangen werden: "+(u?.message||u),r.classList.add("err"),b("emptyMsg").textContent="Keine Daten zum Anzeigen."}};window.addEventListener("message",c),setTimeout(()=>{a||(r.textContent=n||"Keine Daten gefunden.",r.classList.add("err"),b("emptyMsg").textContent="Keine Daten zum Anzeigen.")},5e3);return}I(t)})();
