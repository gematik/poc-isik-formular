const l={pending:"smart:pending",session:"smart:session"},E={clientId:"my_web_app",scope:"launch launch/patient openid profile fhirUser patient/Patient.read patient/Encounter.read patient/Questionnaire.read patient/QuestionnaireResponse.read patient/Observation.read"};function w(t){const n=window.location,e=n.pathname.replace(/\/[^/]*$/,"/");return new URL(t,`${n.origin}${e}`).toString()}function T(){return w("index.html")}function h(t){if(!t)return null;try{return JSON.parse(t)}catch{return null}}function b(t){sessionStorage.setItem(l.pending,JSON.stringify(t))}function x(){return h(sessionStorage.getItem(l.pending))}function P(){sessionStorage.removeItem(l.pending)}function k(t){sessionStorage.setItem(l.session,JSON.stringify(t))}function z(){return h(sessionStorage.getItem(l.session))}function I(){sessionStorage.removeItem(l.session)}function _(t){const n=t instanceof Uint8Array?t:new Uint8Array(t);let e="";for(let o=0;o<n.byteLength;o+=1)e+=String.fromCharCode(n[o]);return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function m(t=32){const n=new Uint8Array(t);return window.crypto.getRandomValues(n),_(n)}async function g(){const t=m(64),n=new TextEncoder().encode(t),e=await window.crypto.subtle.digest("SHA-256",n),o=_(e);return{verifier:t,challenge:o}}function S(t){return t?t.replace(/\/+$/,""):""}function c(t,n){if(!t)return t;try{return new URL(t,n).toString()}catch{throw new Error(`Ungueltige URL in SMART-Konfiguration: ${t}`)}}async function p(t,n={}){const e=await fetch(t,n);if(!e.ok){const o=new Error(`HTTP ${e.status} beim Laden von ${t}`);throw o.status=e.status,o}return e.json()}async function U(t){const n=S(t);if(!n)throw new Error("FHIR Basis-URL (iss) fehlt.");const e=`${n}/`,o=`${n}/.well-known/smart-configuration`;try{const r=await p(o,{headers:{Accept:"application/json"}});if(!r.authorization_endpoint||!r.token_endpoint)throw new Error("SMART-Konfiguration unvollstaendig (authorize/token fehlen).");return{source:"well-known",configurationUrl:o,authorization_endpoint:c(r.authorization_endpoint,e),token_endpoint:c(r.token_endpoint,e),registration_endpoint:r.registration_endpoint?c(r.registration_endpoint,e):void 0,introspection_endpoint:r.introspection_endpoint?c(r.introspection_endpoint,e):void 0,revocation_endpoint:r.revocation_endpoint?c(r.revocation_endpoint,e):void 0}}catch(r){if(r.status&&r.status!==404)throw r}const s=`${n}/metadata`,a=await p(s,{headers:{Accept:"application/fhir+json"}}),d=(Array.isArray(a.rest)?a.rest.find(r=>r.mode==="server"):null)?.security?.extension?.find(r=>r.url==="http://fhir-registry.smarthealthit.org/StructureDefinition/oauth-uris");if(!d?.extension)throw new Error("FHIR CapabilityStatement enthaelt keine SMART OAuth-Informationen.");const i={};for(const r of d.extension)r?.url&&(r.url==="authorize"&&(i.authorization_endpoint=r.valueUri||r.valueUrl),r.url==="token"&&(i.token_endpoint=r.valueUri||r.valueUrl),r.url==="register"&&(i.registration_endpoint=r.valueUri||r.valueUrl),r.url==="manage"&&(i.management_endpoint=r.valueUri||r.valueUrl),r.url==="introspect"&&(i.introspection_endpoint=r.valueUri||r.valueUrl),r.url==="revoke"&&(i.revocation_endpoint=r.valueUri||r.valueUrl));if(!i.authorization_endpoint||!i.token_endpoint)throw new Error("CapabilityStatement liefert keine vollstaendigen OAuth-Endpunkte.");return{source:"metadata",configurationUrl:s,authorization_endpoint:c(i.authorization_endpoint,e),token_endpoint:c(i.token_endpoint,e),registration_endpoint:i.registration_endpoint?c(i.registration_endpoint,e):void 0,management_endpoint:i.management_endpoint?c(i.management_endpoint,e):void 0,introspection_endpoint:i.introspection_endpoint?c(i.introspection_endpoint,e):void 0,revocation_endpoint:i.revocation_endpoint?c(i.revocation_endpoint,e):void 0}}async function L({iss:t,launch:n,clientId:e,scope:o,redirectUri:s}){const a=await U(t),{verifier:u,challenge:f}=await g(),d=m(32),i=new URL(a.authorization_endpoint);return i.searchParams.set("response_type","code"),i.searchParams.set("client_id",e),i.searchParams.set("redirect_uri",s),i.searchParams.set("scope",o),i.searchParams.set("state",d),i.searchParams.set("aud",t),i.searchParams.set("code_challenge",f),i.searchParams.set("code_challenge_method","S256"),n&&i.searchParams.set("launch",n),{authorizationUrl:i.toString(),pending:{createdAt:Date.now(),iss:t,launch:n||null,clientId:e,scope:o,redirectUri:s,state:d,codeVerifier:u,tokenEndpoint:a.token_endpoint,configurationSource:a.source}}}function $(t){if(!t)return null;try{return new URL(t,window.location.href).toString()}catch{throw new Error(`Ungueltige redirect_uri: ${t}`)}}function y(t){if(!t)return"";const n=t.replace(/-/g,"+").replace(/_/g,"/"),e=(4-n.length%4)%4,o=n+"=".repeat(e);return atob(o)}function v(t){if(!t)return null;const n=t.split(".");if(n.length<2)return null;try{const e=y(n[1]);return JSON.parse(e)}catch{return null}}function A(t){const n={},e=t?.fhirContext||t?.fhir_context;return t?.patient&&(n.patient=t.patient),t?.encounter&&(n.encounter=t.encounter),t?.location&&(n.location=t.location),e?.patient&&!n.patient&&(n.patient=e.patient),e?.encounter&&!n.encounter&&(n.encounter=e.encounter),e?.location&&!n.location&&(n.location=e.location),t?.fhirUser&&(n.fhirUser=t.fhirUser),t?.fhir_user&&!n.fhirUser&&(n.fhirUser=t.fhir_user),n}async function O(t,n){if(!t?.tokenEndpoint)throw new Error("SMART Token Endpoint fehlt im gespeicherten Launch-State.");const e=new URLSearchParams({grant_type:"authorization_code",code:n,redirect_uri:t.redirectUri,client_id:t.clientId,code_verifier:t.codeVerifier}),o=await fetch(t.tokenEndpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()}),s=await o.text();let a=null;if(s)try{a=JSON.parse(s)}catch{a=null}if(!o.ok){const u=s?s.slice(0,200):"";throw new Error(`SMART Token Endpoint antwortete mit HTTP ${o.status}. ${u}`)}if(!a||typeof a!="object")throw new Error("SMART Token Endpoint lieferte keine JSON-Antwort.");return a}function M(t,n){if(!n?.access_token)throw new Error("SMART Token Antwort enthaelt kein access_token.");const e=Date.now(),o=Number.parseInt(n.expires_in??"",10),s=Number.isFinite(o)?e+Math.max(0,o)*1e3:null,a=A(n);if(!a.fhirUser&&n?.id_token){const u=v(n.id_token);u?.fhirUser&&(a.fhirUser=u.fhirUser),u?.profile&&(a.profile=u.profile)}return a.fhirUser&&!a.user&&(a.user=a.fhirUser),{createdAt:e,accessToken:n.access_token,tokenType:n.token_type||"Bearer",scope:n.scope||t.scope,expiresAt:s,refreshToken:n.refresh_token||null,idToken:n.id_token||null,patientBanner:n.need_patient_banner??null,smartStyleUrl:n.smart_style_url||null,context:a,iss:t.iss,launch:t.launch,clientId:t.clientId,tokenEndpoint:t.tokenEndpoint,rawResponse:n}}function C(t,n=6e4){return t?.expiresAt?Date.now()+Math.max(0,n)>=t.expiresAt:!1}export{E as S,x as a,O as b,M as c,P as d,I as e,L as f,T as g,b as h,C as i,$ as n,z as r,k as s};
